<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>KO POC</title>
    <script src="Scripts/knockout-3.3.0.js"></script>
    <script src="Scripts/jquery-2.1.4.min.js"></script>
    <script src="Scripts/underscore.min.js"></script>
    <script src="Scripts/underscore.nest.js"></script>
    <script src="Scripts/moment.min.js"></script>
    <script src="Controllers/revenueForecastCtrl.js"></script>
    <style>
        .aggregateColumn {
            background-color: #eee7e7;
            font-weight: bold;
        }

        .group-row {
            border-bottom: 1px solid #67d060;
            overflow: hidden;
            width: 100%;
            padding: 15px 10px;
        }

        .group-panel {
            width: 200px;
            float: left;
            height: 100%;
        }

        .group-table-container {
            overflow: hidden;
        }

            .group-table-container table {
                border-collapse: collapse;
                width: 100%;
                table-layout: fixed;
            }

                .group-table-container table tr {
                    border-bottom: 1px solid #d8d6d6;
                }

                .group-table-container table td {
                    padding: 5px 5px;
                    /*border-right: 1px solid black;*/
                    text-align: right;
                }

                    .group-table-container table td.name-column {
                        width: 150px;
                        text-align: left;
                        color: #808080;
                    }

        .totalsDiv {
            background-color: #f7fff2;
            border-radius: 5px;
            border: 2px solid #8AC007;
        }

        .templateDiv {
            font-family: Arial;
            width: 96%;
        }
    </style>
</head>
<body>

    <div><a href="shmindex.html">Shm index html</a></div>

    <div data-bind="template: { name: 'treeNode1', foreach: result1 }" class="templateDiv"></div>

    <script type="text/html" id="treeNode1">
        <div class="group-row" data-bind="css: { totalsDiv: level() == 0 }">
            <div class="group-panel">
                <div data-bind="style: { marginLeft: (level()) * 1 + 'em' }">
                    <span data-bind="text: name" style="font-weight: bold"></span>
                    <div style="color: #808080; font-size: 11pt;"><span data-bind="text: $root.groupItemsCount(level(), children().length)"></span></div>
                </div>
            </div>
            <div class="group-table-container">
                <table data-bind="foreach: table">
                    <tr data-bind="if: $parent.level() === 0 && $index() === 0">
                        <td></td>
                        <!-- ko foreach: $root.tableHeaderMonthQuarterArray -->
                        <td data-bind="text: $data, css: { aggregateColumn: ($index() + 1) % 4 === 0 }"></td>
                        <!-- /ko -->
                    </tr>
                    <tr>
                        <td data-bind="text: name" class="name-column"></td>
                        <!-- ko foreach: values -->
                        <td data-bind="text: $data"></td>
                        <!-- ko if: ($index() + 1) % 3 == 0 -->
                        <td data-bind="text: $root.sumQuarter($parent.values, $index())" class="aggregateColumn"></td>
                        <!-- /ko -->
                        <!-- /ko -->
                    </tr>
                </table>
            </div>
        </div>
        <div data-bind="template: { name: 'treeNode1', foreach: children }"></div>
    </script>

    <script type="text/javascript">

        //var ops = new RevenueForecastCtrl().getData(6);

        function Node(name, level, children, demand, supply) {
            var self = this;
            self.name = ko.observable(name);
            self.level = ko.observable(level);
            self.demand = ko.observableArray(demand || []);
            self.supply = ko.observableArray(supply || []);
            self.gap = ko.computed(function () {
                var gapValues = [];
                _.forEach(self.demand(), function (item, index) {
                    gapValues.push(item - self.supply()[index]);
                });
                return gapValues;
            });

            self.children = ko.observableArray(children);
            self.SumRootChidlrenArrays = function (tree, resultArray, propertyName) {
                if (tree.children().length === 0) {
                    return tree[propertyName]();
                }

                for (var i = 0; i < tree.children().length; i++) {
                    var child = tree.children()[i];
                    for (var j = 0; j < child[propertyName]().length; j++) {
                        var demandValue = child[propertyName]()[j];
                        resultArray[j] += demandValue;
                    }
                    self.SumRootChidlrenArrays(child, resultArray, propertyName);
                }
                return resultArray;
            }

            self.table = ko.computed(function () {
                var metrics = ["demand", "supply", "gap"];
                var metricNames = ["Demand FTE", "Supply FTE", "Gap FTE"];
                var resultMetrics = [];
                for (var i = 0; i < metrics.length; i++) {
                    var metricName = metrics[i];
                    var metricComptutedValues = [0, 0, 0, 0, 0, 0];
                    metricComptutedValues = self.SumRootChidlrenArrays(self, metricComptutedValues, metricName);
                    resultMetrics.push({ name: metricNames[i], values: metricComptutedValues });
                }
                return resultMetrics;
            });

            self.isOpened = ko.observable();
            self.isClosed = ko.computed(function () {
                self.isOpened(!self.isOpened());
            });
            self.isLeaf = !self.children.length;
        }

        var data1 = [
            new Node("Total", 0, [
                new Node("90...100%", 1,
                    [
                        new Node("Skype", 2,
                            [
                                new Node("Skype Front End", 3, [],
                                    [12, 1, 55, 153, 4, 40],
                                    [112, 31, 5, 53, 43, 41]
                                ),
                                new Node("Skype Back End", 3, [],
                                    [15, 12, 5, 15, 43, 10],
                                    [12, 3, 51, 23, 23, 14]
                                )
                            ],
                            [0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0]
                        ),
                        new Node("Allocine", 2, [
                                new Node("Allocine Front End", 3, [],
                                    [11, 2, 5, 6, 7, 10],
                                    [4, 1, 4, 5, 6, 11]
                                ),
                                new Node("Allocine Back", 3, [],
                                    [6, 6, 3, 7, 2, 3],
                                    [1, 5, 2, 5, 3, 7]
                                )
                        ],
                            [0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0]
                        )
                    ],
                    [0, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0]
                ),
                new Node("80...89%", 1,
                    [
                        new Node("HP", 2,
                            [
                                new Node("HP Front End", 3, [],
                                    [1, 3, 12, 5, 6, 7],
                                    [12, 43, 132, 45, 26, 27]
                                )
                            ],
                            [0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0]
                        )
                    ],
                    [0, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0]
                )
            ],
            [0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0]
        )];

        function ViewModel() {
            var self = this;
            self.result1 = ko.observableArray(data1);
            self.sumQuarter = function (array, index) {
                return _.reduce(array.slice(index - 2, index + 1), function (memo, value) {
                    return memo + value;
                });
            };

            self.startDate = ko.pureComputed(function () {
                return moment().startOf("quarter").toDate();
            });
            self.endDate = ko.pureComputed(function () {
                return moment().add(1, "quarter").endOf("quarter").toDate();
            });

            self.groupItemsCount = function (level, childrenCount) {
                var groupType;
                if (level === 0) return "for " + moment(self.startDate()).format("MMM YYYY") + " - " + moment(self.endDate()).format("MMM YYYY");
                else if (level === 1) groupType = " account(s)";
                else if (level === 2) groupType = " opportunitie(s)";
                else return "";
                return childrenCount + groupType;
            };

            self.tableHeaderMonthQuarterArray = ko.pureComputed(function () {
                console.log("tableHeaderMonthQuarterArray");
                var start = moment(self.startDate());
                var end = moment(self.endDate());
                var headers = [];
                for (var currentDate = start, i = 0; currentDate < end; currentDate.add(1, "month"), i++) {
                    headers.push(moment(currentDate).format("MMM"));
                    if ((i + 1) % 3 === 0) {
                        headers.push("Q" + currentDate.quarter());
                    }
                }
                return headers;
            });
        }
        ko.applyBindings(new ViewModel());

    </script>

</body>
</html>